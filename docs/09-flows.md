# ğŸ”„ Flow Hoáº¡t Äá»™ng Chi Tiáº¿t

## ğŸ“Š Request Processing Flow

### Flow Tá»•ng QuÃ¡t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT REQUEST                         â”‚
â”‚              POST /api/messages                             â”‚
â”‚              Authorization: Bearer {token}                  â”‚
â”‚              Content-Type: application/json                 â”‚
â”‚              Body: { text, receiver_id, receiver_type }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 1: RequestIdInterceptor                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Generate unique request ID: req_1234567890_abc123       â”‚
â”‚  â€¢ Set X-Request-ID header                                  â”‚
â”‚  â€¢ Initialize AsyncLocalStorage context                    â”‚
â”‚  â€¢ Store: { requestId, userId, ip, userAgent, startTime }  â”‚
â”‚                                                             â”‚
â”‚  Context: {                                                 â”‚
â”‚    requestId: "req_1234567890_abc123",                     â”‚
â”‚    userId: "pending",                                       â”‚
â”‚    ip: "192.168.1.100",                                    â”‚
â”‚    userAgent: "Mozilla/5.0...",                            â”‚
â”‚    startTime: 1698567890123                                â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            STEP 2: SanitizationInterceptor                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input: { text: "<script>alert('xss')</script>Hello" }     â”‚
â”‚                                                             â”‚
â”‚  Process:                                                   â”‚
â”‚  1. Check for dangerous patterns                           â”‚
â”‚  2. Remove <script> tags                                   â”‚
â”‚  3. Remove <iframe> tags                                   â”‚
â”‚  4. Remove event handlers (onclick, onerror, etc.)         â”‚
â”‚  5. Remove javascript: protocol                            â”‚
â”‚  6. Escape HTML entities                                   â”‚
â”‚                                                             â”‚
â”‚  Output: { text: "alert('xss')Hello" }                     â”‚
â”‚                                                             â”‚
â”‚  Cache Check:                                               â”‚
â”‚  â€¢ Check if string was sanitized before                    â”‚
â”‚  â€¢ Return cached result if exists                          â”‚
â”‚  â€¢ Store new result in cache (max 1000 items)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               STEP 3: JwtAuthGuard                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Check if route is @Public() decorated                   â”‚
â”‚     â””â”€â–º If YES â†’ Skip authentication                        â”‚
â”‚     â””â”€â–º If NO â†’ Continue                                    â”‚
â”‚                                                             â”‚
â”‚  2. Extract token from request                              â”‚
â”‚     â€¢ Check Authorization header: "Bearer {token}"         â”‚
â”‚     â€¢ Check cookie: access_token                           â”‚
â”‚     â€¢ If no token found â†’ Throw 401 Unauthorized           â”‚
â”‚                                                             â”‚
â”‚  3. Verify JWT token                                        â”‚
â”‚     â€¢ Decode token with JWT_SECRET                         â”‚
â”‚     â€¢ Check expiration time                                â”‚
â”‚     â€¢ Validate signature                                   â”‚
â”‚                                                             â”‚
â”‚  4. Load user payload                                       â”‚
â”‚     Payload: {                                              â”‚
â”‚       sub: "user123",                                       â”‚
â”‚       phone: "+84901234567",                        â”‚
â”‚       username: "john_doe",                                â”‚
â”‚       role: "user",                                         â”‚
â”‚       permissions: ["read", "write"],                      â”‚
â”‚       iat: 1698567890,                                     â”‚
â”‚       exp: 1699172690                                      â”‚
â”‚     }                                                        â”‚
â”‚                                                             â”‚
â”‚  5. Attach user to request                                  â”‚
â”‚     request.user = payload                                  â”‚
â”‚                                                             â”‚
â”‚  If token invalid/expired:                                  â”‚
â”‚  â””â”€â–º Throw 401: "JWT token expired" or "Invalid JWT token" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           STEP 4: RolesGuard (if @Roles() exists)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controller cÃ³ @Roles('admin', 'moderator')                 â”‚
â”‚                                                             â”‚
â”‚  1. Get required roles from metadata                        â”‚
â”‚     Required: ['admin', 'moderator']                        â”‚
â”‚                                                             â”‚
â”‚  2. Get user role from request.user                         â”‚
â”‚     User role: 'user'                                       â”‚
â”‚                                                             â”‚
â”‚  3. Check if user role matches any required role            â”‚
â”‚     'user' âˆˆ ['admin', 'moderator']? â†’ NO                  â”‚
â”‚                                                             â”‚
â”‚  4. Result: Throw 403 Forbidden                             â”‚
â”‚     "Insufficient permissions"                              â”‚
â”‚                                                             â”‚
â”‚  If role matches â†’ Continue to next step                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               STEP 5: ThrottleGuard                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Configuration: 100 requests per 60 seconds                 â”‚
â”‚                                                             â”‚
â”‚  1. Generate tracker key                                    â”‚
â”‚     IP: 192.168.1.100                                      â”‚
â”‚     User ID: user123                                        â”‚
â”‚     Tracker: "192.168.1.100:user123"                       â”‚
â”‚                                                             â”‚
â”‚  2. Check rate limit                                        â”‚
â”‚     Current count: 98/100                                   â”‚
â”‚     Window start: 1698567830                                â”‚
â”‚     Window end: 1698567890                                  â”‚
â”‚                                                             â”‚
â”‚  3. Increment counter                                       â”‚
â”‚     New count: 99/100                                       â”‚
â”‚                                                             â”‚
â”‚  4. Check if exceeded                                       â”‚
â”‚     99 < 100 â†’ OK, allow request                           â”‚
â”‚                                                             â”‚
â”‚  If exceeded (e.g., 101/100):                              â”‚
â”‚  â””â”€â–º Throw 429: "Too many requests"                        â”‚
â”‚       Set header: Retry-After: 60                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             STEP 6: LoggingInterceptor                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Log Incoming Request:                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [2025-10-29 10:30:45] INFO                          â”‚  â”‚
â”‚  â”‚ Incoming Request:                                    â”‚  â”‚
â”‚  â”‚   Method: POST                                       â”‚  â”‚
â”‚  â”‚   URL: /api/messages                                 â”‚  â”‚
â”‚  â”‚   IP: 192.168.1.100                                 â”‚  â”‚
â”‚  â”‚   User-Agent: Mozilla/5.0...                        â”‚  â”‚
â”‚  â”‚   Request-ID: req_1234567890_abc123                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  Start timer for response logging                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            STEP 7: MetricsInterceptor                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Generate metric name                                    â”‚
â”‚     Method: POST                                            â”‚
â”‚     Path: /api/messages                                     â”‚
â”‚     Sanitized: /api/messages                                â”‚
â”‚     Metric: "http_post_api_messages"                        â”‚
â”‚                                                             â”‚
â”‚  2. Start timer                                             â”‚
â”‚     timerKey: "http_post_api_messages:req_123..."          â”‚
â”‚     startTime: 1698567890123                                â”‚
â”‚                                                             â”‚
â”‚  3. Increment request counter                               â”‚
â”‚     Counter: http_requests_total{method="POST",path="/api/messages"}â”‚
â”‚     Value: 1234 â†’ 1235                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STEP 8: PerformanceInterceptor                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Configuration:                                             â”‚
â”‚  â€¢ Slow request threshold: 1000ms                           â”‚
â”‚                                                             â”‚
â”‚  Start performance tracking:                                â”‚
â”‚  â€¢ Record start time: 1698567890123                         â”‚
â”‚  â€¢ Method: POST                                             â”‚
â”‚  â€¢ URL: /api/messages                                       â”‚
â”‚                                                             â”‚
â”‚  (Will check duration after response)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             STEP 9: TimeoutInterceptor                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Configuration:                                             â”‚
â”‚  â€¢ Default timeout: 30000ms (30 seconds)                    â”‚
â”‚  â€¢ File upload timeout: 300000ms (5 minutes)                â”‚
â”‚                                                             â”‚
â”‚  Set timeout for request:                                   â”‚
â”‚  â€¢ Start timeout timer: 30000ms                             â”‚
â”‚  â€¢ If request exceeds timeout:                              â”‚
â”‚    â””â”€â–º Throw RequestTimeoutException                        â”‚
â”‚         "Request timeout"                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            STEP 10: CacheInterceptor                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Check if route has @Cache() decorator                   â”‚
â”‚     This route: NO @Cache() â†’ Skip caching                  â”‚
â”‚                                                             â”‚
â”‚  Example with cache:                                        â”‚
â”‚  Route: GET /users/:id                                      â”‚
â”‚  Decorator: @Cache({ key: 'user:profile', ttl: 1800 })     â”‚
â”‚                                                             â”‚
â”‚  2. Generate cache key                                      â”‚
â”‚     Base: "user:profile"                                    â”‚
â”‚     User ID: "user123"                                      â”‚
â”‚     Final: "user:profile:user123"                           â”‚
â”‚                                                             â”‚
â”‚  3. Check cache                                             â”‚
â”‚     Result: MISS                                            â”‚
â”‚                                                             â”‚
â”‚  4. If HIT â†’ Return cached data                             â”‚
â”‚     If MISS â†’ Continue to controller                        â”‚
â”‚                                                             â”‚
â”‚  5. After response, store in cache (if cacheable)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 11: CONTROLLER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MessagesController.create()                                â”‚
â”‚                                                             â”‚
â”‚  1. Extract data from request                               â”‚
â”‚     @Body() createMessageDto: CreateMessageDto              â”‚
â”‚     @CurrentUser() user: User                               â”‚
â”‚                                                             â”‚
â”‚  2. Validate DTO with class-validator                       â”‚
â”‚     CreateMessageDto {                                      â”‚
â”‚       text: "Hello World" âœ“                                â”‚
â”‚       receiver_id: "group123" âœ“                            â”‚
â”‚       receiver_type: "group" âœ“                             â”‚
â”‚     }                                                        â”‚
â”‚                                                             â”‚
â”‚  3. Call service method                                     â”‚
â”‚     return messagesService.create(                          â”‚
â”‚       createMessageDto,                                     â”‚
â”‚       user.id                                               â”‚
â”‚     )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STEP 12: SERVICE (Business Logic)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MessagesService.create()                                   â”‚
â”‚                                                             â”‚
â”‚  1. Validate receiver                                       â”‚
â”‚     receiverType: "group"                                   â”‚
â”‚     receiverId: "group123"                                  â”‚
â”‚                                                             â”‚
â”‚     a. Check if group exists                                â”‚
â”‚        await groupsService.findOne("group123")              â”‚
â”‚        Result: Group found âœ“                                â”‚
â”‚                                                             â”‚
â”‚     b. Check if user is group member                        â”‚
â”‚        user.groups.includes("group123")                     â”‚
â”‚        Result: true âœ“                                       â”‚
â”‚                                                             â”‚
â”‚  2. Create message document                                 â”‚
â”‚     const message = {                                       â”‚
â”‚       sender_id: "user123",                                 â”‚
â”‚       receiver_type: "group",                               â”‚
â”‚       receiver_id: "group123",                              â”‚
â”‚       text: "Hello World",                                  â”‚
â”‚       is_read: false,                                       â”‚
â”‚       created_at: new Date(),                               â”‚
â”‚       updated_at: new Date()                                â”‚
â”‚     }                                                        â”‚
â”‚                                                             â”‚
â”‚  3. Save to database                                        â”‚
â”‚     await messageRepository.create(message)                 â”‚
â”‚     MongoDB: Insert successful                              â”‚
â”‚     Result: { _id: "msg456", ...message }                   â”‚
â”‚                                                             â”‚
â”‚  4. Send notifications (async)                              â”‚
â”‚     a. Get all group members                                â”‚
â”‚        members = ["user456", "user789", ...]               â”‚
â”‚                                                             â”‚
â”‚     b. Exclude sender                                       â”‚
â”‚        recipients = members.filter(id => id !== "user123")  â”‚
â”‚                                                             â”‚
â”‚     c. Send notification to each                            â”‚
â”‚        await notificationService.sendGroupNotification(     â”‚
â”‚          recipient,                                         â”‚
â”‚          groupName,                                         â”‚
â”‚          messagePreview                                     â”‚
â”‚        )                                                     â”‚
â”‚                                                             â”‚
â”‚  5. Emit WebSocket event                                    â”‚
â”‚     socketGateway.emitToGroup("group123", {                 â”‚
â”‚       event: "new_message",                                 â”‚
â”‚       data: message                                         â”‚
â”‚     })                                                       â”‚
â”‚                                                             â”‚
â”‚  6. Track analytics                                         â”‚
â”‚     analyticsService.trackMessageSent(                      â”‚
â”‚       "user123",                                            â”‚
â”‚       "group",                                              â”‚
â”‚       "group123"                                            â”‚
â”‚     )                                                        â”‚
â”‚                                                             â”‚
â”‚  7. Return message                                          â”‚
â”‚     return message                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 13: ResponseTransformInterceptor                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input (from service):                                      â”‚
â”‚  {                                                          â”‚
â”‚    _id: "msg456",                                           â”‚
â”‚    sender_id: "user123",                                    â”‚
â”‚    receiver_type: "group",                                  â”‚
â”‚    receiver_id: "group123",                                 â”‚
â”‚    text: "Hello World",                                     â”‚
â”‚    is_read: false,                                          â”‚
â”‚    created_at: "2025-10-29T10:30:45.123Z"                  â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â”‚  Transform to standard format:                              â”‚
â”‚  {                                                          â”‚
â”‚    success: true,                                           â”‚
â”‚    data: {                                                  â”‚
â”‚      _id: "msg456",                                         â”‚
â”‚      sender_id: "user123",                                  â”‚
â”‚      receiver_type: "group",                                â”‚
â”‚      receiver_id: "group123",                               â”‚
â”‚      text: "Hello World",                                   â”‚
â”‚      is_read: false,                                        â”‚
â”‚      created_at: "2025-10-29T10:30:45.123Z"                â”‚
â”‚    },                                                       â”‚
â”‚    timestamp: "2025-10-29 10:30:45"                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 14: Complete Metrics & Logging                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MetricsInterceptor:                                        â”‚
â”‚  â€¢ End timer: duration = 145ms                              â”‚
â”‚  â€¢ Record histogram: http_request_duration_ms = 145         â”‚
â”‚  â€¢ Increment counter: http_requests_success = +1            â”‚
â”‚                                                             â”‚
â”‚  PerformanceInterceptor:                                    â”‚
â”‚  â€¢ Duration: 145ms                                          â”‚
â”‚  â€¢ Threshold: 1000ms                                        â”‚
â”‚  â€¢ 145 < 1000 â†’ No warning (request is fast)                â”‚
â”‚                                                             â”‚
â”‚  LoggingInterceptor:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [2025-10-29 10:30:45] INFO                          â”‚  â”‚
â”‚  â”‚ Outgoing Response:                                   â”‚  â”‚
â”‚  â”‚   Method: POST                                       â”‚  â”‚
â”‚  â”‚   URL: /api/messages                                 â”‚  â”‚
â”‚  â”‚   Status: 201                                        â”‚  â”‚
â”‚  â”‚   Duration: 145ms                                    â”‚  â”‚
â”‚  â”‚   Request-ID: req_1234567890_abc123                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  RequestIdInterceptor:                                      â”‚
â”‚  â€¢ Set response headers:                                    â”‚
â”‚    X-Request-ID: req_1234567890_abc123                     â”‚
â”‚    X-Correlation-ID: req_1234567890_abc123                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FINAL RESPONSE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Status: 201 Created                                        â”‚
â”‚                                                             â”‚
â”‚  Headers:                                                   â”‚
â”‚    Content-Type: application/json                           â”‚
â”‚    X-Request-ID: req_1234567890_abc123                     â”‚
â”‚    X-Correlation-ID: req_1234567890_abc123                 â”‚
â”‚                                                             â”‚
â”‚  Body:                                                      â”‚
â”‚  {                                                          â”‚
â”‚    "success": true,                                         â”‚
â”‚    "data": {                                                â”‚
â”‚      "_id": "msg456",                                       â”‚
â”‚      "sender_id": "user123",                                â”‚
â”‚      "receiver_type": "group",                              â”‚
â”‚      "receiver_id": "group123",                             â”‚
â”‚      "text": "Hello World",                                 â”‚
â”‚      "is_read": false,                                      â”‚
â”‚      "created_at": "2025-10-29T10:30:45.123Z"              â”‚
â”‚    },                                                       â”‚
â”‚    "timestamp": "2025-10-29 10:30:45"                      â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Authentication Flow

### User Registration

```
Client                  Controller              Service                 Database
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚  POST /auth/register    â”‚                      â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                       â”‚
  â”‚  {                      â”‚                      â”‚                       â”‚
  â”‚    phone,        â”‚  Validate DTO        â”‚                       â”‚
  â”‚    password,            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º        â”‚                       â”‚
  â”‚    full_name            â”‚                      â”‚                       â”‚
  â”‚  }                      â”‚                      â”‚  Check existing user  â”‚
  â”‚                         â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                      â”‚  User not found       â”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚  Hash password        â”‚
  â”‚                         â”‚                      â”‚  (bcrypt, 12 rounds)  â”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚  Create user document â”‚
  â”‚                         â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                      â”‚  User created         â”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚  Generate JWT         â”‚
  â”‚                         â”‚                      â”‚  (JWT_SECRET, 7d)     â”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                         â”‚  { access_token,     â”‚                       â”‚
  â”‚                         â”‚    user_data }       â”‚                       â”‚
  â”‚                         â”‚                      â”‚                       â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                       â”‚
  â”‚  201 Created            â”‚                      â”‚                       â”‚
  â”‚  {                      â”‚                      â”‚                       â”‚
  â”‚    success: true,       â”‚                      â”‚                       â”‚
  â”‚    data: {              â”‚                      â”‚                       â”‚
  â”‚      access_token,      â”‚                      â”‚                       â”‚
  â”‚      user: {...}        â”‚                      â”‚                       â”‚
  â”‚    }                    â”‚                      â”‚                       â”‚
  â”‚  }                      â”‚                      â”‚                       â”‚
  â”‚                         â”‚                      â”‚                       â”‚
```

### User Login

```
1. Client gá»­i credentials
   â””â”€â–º { phone: "+84901234567", password: "MyPassword123!" }

2. AuthController nháº­n request
   â””â”€â–º Validate LoginDto

3. AuthService.validateUser()
   â”œâ”€â–º Find user by phone
   â”‚   â””â”€â–º userRepository.findOne({ phone })
   â”‚
   â”œâ”€â–º Check if user exists
   â”‚   â””â”€â–º If not found: Throw UnauthorizedException
   â”‚
   â”œâ”€â–º Compare password
   â”‚   â””â”€â–º bcrypt.compare(plainPassword, hashedPassword)
   â”‚   â””â”€â–º If not match: Throw UnauthorizedException
   â”‚
   â””â”€â–º User validated âœ“

4. AuthService.login()
   â”œâ”€â–º Create JWT payload
   â”‚   â””â”€â–º {
   â”‚         sub: user._id,
   â”‚         phone: user.phone,
   â”‚         username: user.username,
   â”‚         email: user.email,
   â”‚         role: user.role,
   â”‚         permissions: user.permissions
   â”‚       }
   â”‚
   â”œâ”€â–º Sign access token
   â”‚   â””â”€â–º jwt.sign(payload, JWT_SECRET, { expiresIn: '7d' })
   â”‚
   â”œâ”€â–º Sign refresh token
   â”‚   â””â”€â–º jwt.sign(payload, JWT_REFRESH_SECRET, { expiresIn: '30d' })
   â”‚
   â””â”€â–º Return tokens and user data

5. Response to client
   â””â”€â–º {
         success: true,
         data: {
           access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
           refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
           user: { id, phone, full_name, ... }
         }
       }
```

### Authenticated Request

```
1. Client sends request with token
   â””â”€â–º Headers: { Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5..." }

2. JwtAuthGuard.canActivate()
   â”œâ”€â–º Extract token from header or cookie
   â”‚   â””â”€â–º Authorization: Bearer {token}
   â”‚
   â”œâ”€â–º Verify token
   â”‚   â””â”€â–º jwtService.verifyAsync(token, { secret: JWT_SECRET })
   â”‚   â””â”€â–º Check expiration
   â”‚   â””â”€â–º Validate signature
   â”‚
   â”œâ”€â–º If valid: Extract payload
   â”‚   â””â”€â–º { sub, phone, role, permissions, ... }
   â”‚
   â”œâ”€â–º Attach user to request
   â”‚   â””â”€â–º request.user = payload
   â”‚
   â””â”€â–º Return true (allow access)

3. RolesGuard.canActivate() (if applicable)
   â”œâ”€â–º Get required roles from @Roles() decorator
   â”œâ”€â–º Get user role from request.user
   â”œâ”€â–º Check if user role matches
   â””â”€â–º Return true/false

4. Controller receives request with user context
   â””â”€â–º @CurrentUser() decorator provides user data
```

## ğŸ“¨ Message Flow

### Send Direct Message (User to User)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sender  â”‚                                                    â”‚ Receiver â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                               â”‚
     â”‚  POST /messages                                              â”‚
     â”‚  { receiver_id: "user456", receiver_type: "user",            â”‚
     â”‚    text: "Hi there!" }                                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                                             â”‚
     â”‚                                                               â”‚
     â”‚              [Authentication & Authorization]                 â”‚
     â”‚                                                               â”‚
     â”‚              MessagesService.create()                         â”‚
     â”‚              â”œâ”€â–º Validate receiver (user456 exists?)         â”‚
     â”‚              â”œâ”€â–º Create message document                     â”‚
     â”‚              â”œâ”€â–º Save to MongoDB                             â”‚
     â”‚              â”œâ”€â–º Send notification                           â”‚
     â”‚              â”‚   â””â”€â–º NotificationService.sendMessageNotification()â”‚
     â”‚              â”‚       â”œâ”€â–º Create notification document        â”‚
     â”‚              â”‚       â””â”€â–º If receiver online: Push via WebSocketâ”‚
     â”‚              â”‚                                          â”‚     â”‚
     â”‚              â””â”€â–º Emit WebSocket event                  â”‚     â”‚
     â”‚                  â””â”€â–º socketGateway.emitToUser()        â”‚     â”‚
     â”‚                                                         â”‚     â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  201 Created { message }                                     â”‚
     â”‚                                                               â”‚
     â”‚                                           WebSocket Event     â”‚
     â”‚                                           "new_message"       â”‚
     â”‚                                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚                                          â”‚  { message data }  â”‚
     â”‚                                                               â”‚
```

### Send Group Message

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sender â”‚                                              â”‚ Member 1 â”‚ â”‚ Member 2 â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                                                        â”‚            â”‚
    â”‚  POST /messages                                        â”‚            â”‚
    â”‚  { receiver_id: "group123", receiver_type: "group",   â”‚            â”‚
    â”‚    text: "Hello everyone!" }                          â”‚            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                                       â”‚            â”‚
    â”‚                                                         â”‚            â”‚
    â”‚              [Authentication & Authorization]           â”‚            â”‚
    â”‚              â”œâ”€â–º Check if sender is group member       â”‚            â”‚
    â”‚              â”‚                                          â”‚            â”‚
    â”‚              MessagesService.create()                  â”‚            â”‚
    â”‚              â”œâ”€â–º Validate group exists                 â”‚            â”‚
    â”‚              â”œâ”€â–º Check sender membership               â”‚            â”‚
    â”‚              â”œâ”€â–º Create message document               â”‚            â”‚
    â”‚              â”œâ”€â–º Save to MongoDB                       â”‚            â”‚
    â”‚              â”œâ”€â–º Get all group members                 â”‚            â”‚
    â”‚              â”‚   â””â”€â–º ["user456", "user789", ...]       â”‚            â”‚
    â”‚              â”‚                                          â”‚            â”‚
    â”‚              â”œâ”€â–º Send notifications to all members     â”‚            â”‚
    â”‚              â”‚   (excluding sender)                    â”‚            â”‚
    â”‚              â”‚   â”œâ”€â–º For each member:                  â”‚            â”‚
    â”‚              â”‚   â”‚   â””â”€â–º notificationService.sendGroupNotification()â”‚
    â”‚              â”‚   â”‚                                      â”‚            â”‚
    â”‚              â”‚   WebSocket: Emit to group              â”‚            â”‚
    â”‚              â”‚   â””â”€â–º socketGateway.emitToGroup()       â”‚            â”‚
    â”‚              â”‚                                          â”‚            â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                         â”‚            â”‚
    â”‚  201 Created â”‚                                         â”‚            â”‚
    â”‚              â”‚                                         â”‚            â”‚
    â”‚              â”‚                WebSocket "new_message"  â”‚            â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
    â”‚              â”‚                { message }               â”‚            â”‚
    â”‚              â”‚                                          â”‚            â”‚
    â”‚              â”‚                WebSocket "new_message"  â”‚            â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚                { message }                            â”‚
    â”‚                                                         â”‚            â”‚
```

## ğŸ” Error Handling Flow

### Validation Error Flow

```
Client sends invalid data
{ text: "", receiver_id: "invalid-id", receiver_type: "unknown" }
    â”‚
    â–¼
ValidationPipe (class-validator)
    â”œâ”€â–º text: IsNotEmpty() â†’ FAIL: "text should not be empty"
    â”œâ”€â–º receiver_id: IsMongoId() â†’ FAIL: "receiver_id must be a valid MongoDB ID"
    â””â”€â–º receiver_type: IsIn(['user', 'group']) â†’ FAIL: "receiver_type must be one of: user, group"
    â”‚
    â–¼
Throw BadRequestException
{ message: ["text should not be empty", "receiver_id must be ...", ...] }
    â”‚
    â–¼
ValidationExceptionFilter.catch()
    â”œâ”€â–º Extract validation errors
    â”œâ”€â–º Transform to standard format
    â””â”€â–º Create error response
    â”‚
    â–¼
Response to client (400 Bad Request)
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "Validation failed",
  "details": [
    { "field": "text", "message": "text should not be empty" },
    { "field": "receiver_id", "message": "receiver_id must be a valid MongoDB ID" },
    { "field": "receiver_type", "message": "receiver_type must be one of: user, group" }
  ],
  "timestamp": "2025-10-29 10:30:45",
  "path": "/api/messages",
  "method": "POST",
  "requestId": "req_1234567890_abc123"
}
```

### Database Error Flow

```
Service tries to create duplicate user
{ phone: "+84901234567", ... } (already exists)
    â”‚
    â–¼
MongoDB throws MongoError
{ code: 11000, message: "E11000 duplicate key error..." }
    â”‚
    â–¼
DatabaseExceptionFilter.catch()
    â”œâ”€â–º Check error code
    â”‚   â””â”€â–º 11000 = Duplicate Key
    â”œâ”€â–º Determine status code
    â”‚   â””â”€â–º 409 Conflict
    â”œâ”€â–º Create user-friendly message
    â”‚   â””â”€â–º "Duplicate entry found"
    â””â”€â–º Log error details
    â”‚
    â–¼
Response to client (409 Conflict)
{
  "success": false,
  "error": "DUPLICATE_ENTRY",
  "message": "Duplicate entry found",
  "details": "E11000 duplicate key error...",
  "timestamp": "2025-10-29 10:30:45",
  "path": "/api/auth/register",
  "method": "POST",
  "requestId": "req_1234567890_abc123"
}
```

### Rate Limit Error Flow

```
User makes 101st request in 1 minute (limit: 100)
    â”‚
    â–¼
ThrottleGuard.canActivate()
    â”œâ”€â–º Check request count for user
    â”‚   â””â”€â–º Current: 101, Limit: 100
    â”œâ”€â–º Count exceeded!
    â””â”€â–º Throw ThrottlerException
    â”‚
    â–¼
RateLimitExceptionFilter.catch()
    â”œâ”€â–º Create error response
    â”œâ”€â–º Set Retry-After header: 60 seconds
    â”œâ”€â–º Set rate limit headers:
    â”‚   â”œâ”€â–º X-RateLimit-Limit: 100
    â”‚   â”œâ”€â–º X-RateLimit-Remaining: 0
    â”‚   â””â”€â–º X-RateLimit-Reset: {timestamp}
    â””â”€â–º Log rate limit violation
    â”‚
    â–¼
Response to client (429 Too Many Requests)
Headers:
  Retry-After: 60
  X-RateLimit-Limit: 100
  X-RateLimit-Remaining: 0
  X-RateLimit-Reset: 1698567950

Body:
{
  "success": false,
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "Too many requests, please try again later",
  "retryAfter": 60,
  "timestamp": "2025-10-29 10:30:45",
  "path": "/api/messages",
  "method": "POST",
  "requestId": "req_1234567890_abc123"
}
```

## ğŸ“Š Metrics Collection Flow

```
Request Start
    â”‚
    â–¼
MetricsInterceptor
    â”‚
    â”œâ”€â–º Generate metric name
    â”‚   â””â”€â–º "http_post_api_messages"
    â”‚
    â”œâ”€â–º Start timer
    â”‚   â””â”€â–º timers.set("http_post_api_messages:req_123", Date.now())
    â”‚
    â”œâ”€â–º Increment request counter
    â”‚   â””â”€â–º counters["http_requests_total"] += 1
    â”‚
    â””â”€â–º Execute request...
        â”‚
        â–¼
    Request Processing
    (145ms elapsed)
        â”‚
        â–¼
    Response Ready
    â”‚
    â–¼
MetricsInterceptor (on response)
    â”‚
    â”œâ”€â–º End timer
    â”‚   â””â”€â–º duration = Date.now() - startTime = 145ms
    â”‚
    â”œâ”€â–º Delete timer entry
    â”‚   â””â”€â–º timers.delete("http_post_api_messages:req_123")
    â”‚
    â”œâ”€â–º Record histogram
    â”‚   â””â”€â–º histograms["http_request_duration_ms"].push(145)
    â”‚
    â”œâ”€â–º Increment success counter
    â”‚   â””â”€â–º counters["http_requests_success"] += 1
    â”‚
    â””â”€â–º Store in circular buffer (max 1000 values)
        â””â”€â–º Prevents memory overflow
```

---

**Next:** [API Examples â†’](./10-api-examples.md)

